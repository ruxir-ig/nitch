name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build binaries
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install choosenim (Nim toolchain)
        run: |
          curl https://nim-lang.org/choosenim/init.sh -sSf | sh -s -- -y
          echo "$HOME/.nimble/bin" >> $GITHUB_PATH
          echo "$HOME/.nim/bin" >> $GITHUB_PATH

      - name: Show Nim version
        run: nim --version

      - name: Build Nerd Font binary
        run: nimble build -d:release -y

      - name: Build Non-Nerd Font binary
        run: nim c -d:release -o:nitchNoNerd src/nitchNoNerd.nim

      - name: Upload binaries as workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nitch-binaries
          path: |
            ./nitch
            ./nitchNoNerd

  packaging-sanity:
    name: Packaging sanity check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate .SRCINFO matches PKGBUILD (run in Arch container)
        run: |
          docker pull archlinux:latest
          docker run --rm -e GITHUB_REPOSITORY='${{ github.repository }}' -e GITHUB_SHA='${{ github.sha }}' archlinux:latest /bin/bash -lc "\
            pacman -Sy --noconfirm --needed base-devel git nim && \
            useradd -m builder && \
            git clone https://$GITHUB_REPOSITORY /tmp/nitch && \
            cd /tmp/nitch && git checkout $GITHUB_SHA || true && \
            su builder -c 'cd /tmp/nitch && makepkg --printsrcinfo > .SRCINFO.new' && \
            diff -u .SRCINFO .SRCINFO.new || (echo '.SRCINFO mismatch' && exit 1)"
